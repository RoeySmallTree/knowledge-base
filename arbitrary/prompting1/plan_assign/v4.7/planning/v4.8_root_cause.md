# V4.7 Plan & Assign Root Cause Analysis

**Purpose:** Analyze issues in V4.7 Plan & Assign prompt and propose fixes for V4.8

---

## CRITICAL Issue 1: Schema Deviation (System Crash Risk)

### The Problem

The LLM outputs **text preamble before JSON**, which will crash the system parser:

```
I'll work through the 6-point planning framework to structure this first round.

1. Mission Alignment Check:
- We need to establish core components for the TODO list MVP
- Key areas needed: architecture design, frontend, backend...

2-3. Structure Decisions:
...

```json
{
  "structureDelta": "...",
  ...
}
```

Rationale for decisions:
...
```

**Impact:** System cannot parse JSON → **crash**

### Root Cause

V4.7 prompt has NO explicit instruction about output format. It shows an example JSON, but:
1. No "Output MUST be pure JSON" instruction
2. No "no preamble" instruction  
3. LLM naturally wants to "explain its thinking" before answering

### Fix for V4.8

Add explicit section:

```markdown
### Output Format

**Your response must be pure JSON only.**

- No explanation before the JSON
- No markdown fences (no ```json)
- No rationale after the JSON
- Start directly with `{` and end with `}`

❌ BAD:
```
I'll analyze the mission...

{
  "structureDelta": ...
}

The rationale is...
```

✅ GOOD:
```
{
  "structureDelta": ...
}
```
```

---

## CRITICAL Issue 2: Missing `reasoning` Field

### The Problem

Bootstrap prompt has a `reasoning` field in the schema. Plan & Assign does NOT:

**Bootstrap schema:**
```json
{
  "reasoning": "string — your thought process interpreting the mission",
  "mission_charter": "...",
  ...
}
```

**Plan & Assign schema (V4.7):**
```json
{
  "structureDelta": "...",
  "changes": [...],
  "assignments": [...],
  "acceptance": [...],
  "questionsForUser": [...]
}
```

Because there's no `reasoning` field, the LLM puts its thinking OUTSIDE the JSON (as preamble).

### Root Cause

Schema inconsistency across steps. Bootstrap has reasoning, Plan & Assign doesn't.

### Fix for V4.8

Add `reasoning` field to Plan & Assign schema:

```json
{
  "reasoning": "string — your assessment of current state and planning decisions",
  "structureDelta": "...",
  "changes": [...],
  ...
}
```

This gives the LLM a proper place to put its thinking INSIDE the JSON.

---

## Issue 3: structureDelta Format Mismatch

### The Problem

V4.7 prompt shows this format:
```
Add Collection: "Marketing Materials"
  > Content: "Landing Page Copy" [operative-1]
  > Content: "Email Sequences" [operative-2]
```

LLM invented its own format:
```
[Orchestration] TODO List MVP
  [Decision] System Architecture Design
  [Collection] Frontend Implementation
    [Content] Core UI Components
```

### Root Cause

1. Only ONE example in the prompt
2. The example doesn't cover all node types
3. No explicit "use EXACTLY this format" instruction

### Fix for V4.8

1. Add multiple examples covering all node types:

```markdown
### structureDelta Format

Use this EXACT format for nested product creation:

**Adding products:**
```
Add Orchestration: "Module Name"
  > Decision: "Decision Name" [operative-1]
  > Collection: "Collection Name"
    > Content: "Item 1" [operative-2]
    > Content: "Item 2" [operative-2]
  > Content: "Standalone Content" [operative-1]
```

**Removing products:**
```
Remove: "Product Name" (UUID: abc123)
```

**Format rules:**
- Always prefix with action: `Add` or `Remove`
- Use `>` for children, indent with 2 spaces per level
- Include assignee in brackets `[operative-1]` for leaf nodes
```

2. Add explicit "do NOT invent your own format" warning

---

## Issue 4: Orchestration vs Collection Clarity

### The Problem

The prompt doesn't clearly explain WHEN to use each:

From V4.7:
```
| Type | Purpose | Children Allowed |
|------|---------|------------------|
| **Content** | Atomic deliverable | None |
| **Decision** | Choice to evaluate | Any type |
| **Collection** | Group of related Content | Content only |
| **Orchestration** | Complex multi-part work | Any type |
```

This table says WHAT they are, not WHEN to use them.

### Evidence from Result

LLM used Collection incorrectly:
```
[Collection] Frontend Implementation
    [Content] Core UI Components
    [Content] State Management
    [Content] Frontend Tests
```

"Frontend Implementation" is complex multi-domain work (design + code + tests) → should be Orchestration, not Collection.

### Root Cause

1. No decision guide with examples
2. "Complex multi-part" vs "group of related" is ambiguous

### Fix for V4.8

Add explicit decision guide with examples:

```markdown
### When to Use Each Product Type

**Collection** = Same-type atomic items that share a semantic category
- Book chapters (all chapters, same structure)
- API endpoint documentation (all docs, same format)  
- Test case files (all tests, same purpose)
- Resource lists (all resources, same type)

**Orchestration** = Complex work spanning multiple domains/concerns
- Full feature module (design + implementation + tests + docs)
- Marketing campaign (budget + copy + channels + metrics)
- Release milestone (planning + development + QA + deployment)

**Decision rule:**
- If children are all the SAME TYPE of atomic content → Collection
- If children span DIFFERENT concerns/domains → Orchestration

**Example - WRONG:**
```
[Collection] Frontend Implementation     ← WRONG: spans design, code, tests
    [Content] Core UI Components
    [Content] State Management  
    [Content] Frontend Tests
```

**Example - RIGHT:**
```
[Orchestration] Frontend Implementation  ← RIGHT: complex multi-domain work
    [Content] Component Specs
    [Content] Source Code
    [Collection] Test Files              ← Collection: all same-type (test files)
        [Content] Unit Tests
        [Content] Integration Tests
```
```

---

## Issue 5: User Prompt Format Inconsistency

### The Problem

V4.7 user prompt uses bracket-based section headers:

```
[MISSION]
Build MenuMaster...

[OBJECTIVES]
1. Reduce menu update time...

[TEAM]
- **Richard** (chair-1)...
```

But the system prompt uses markdown native styling:

```markdown
### Your Purpose

You are the MISSION ARCHITECT...
```

### Root Cause

Inconsistent formatting convention between system and user prompts.

### Fix for V4.8

Update user prompt template to use markdown headers:

```markdown
### MISSION

{{session.mission_charter}}

### OBJECTIVES

{{session.underlying_objectives}}

### TEAM

{{#each members}}
...
```

This aligns with Bootstrap's styling and is more readable.

---

## Summary: V4.8 Changes Required

| Issue | Severity | Fix |
|-------|----------|-----|
| Schema deviation (text preamble) | **CRITICAL** | Add "Output Format" section with explicit pure JSON requirement |
| Missing `reasoning` field | **CRITICAL** | Add `reasoning` as first field in schema |
| structureDelta format | Medium | Multiple examples + explicit format rules |
| Collection vs Orchestration | Medium | Decision guide with good/bad examples |
| User prompt format | Low | Change `[SECTION]` to `### SECTION` for consistency |

---

## Proposed V4.8 Schema

```json
{
  "reasoning": "string — your assessment of current state, mission gaps, and planning decisions",
  
  "structureDelta": "string — text tree for nested creations/removals (optional)",
  
  "changes": [...],
  
  "assignments": [...],
  
  "acceptance": [...],
  
  "questionsForUser": [...]
}
```

---

## Implementation Checklist

- [ ] Add `reasoning` field to schema (first field)
- [ ] Add "Output Format" section requiring pure JSON
- [ ] Add multiple structureDelta examples covering all node types
- [ ] Add "When to Use Each Product Type" section with Collection vs Orchestration guide
- [ ] Update example output to include `reasoning` field
- [ ] Update user prompt: change `[SECTION]` to `### SECTION` (markdown native)
- [ ] Test with same MenuMaster use case to compare
