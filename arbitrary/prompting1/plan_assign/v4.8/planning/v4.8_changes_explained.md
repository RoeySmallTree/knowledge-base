# V4.8 Plan & Assign: Changes & Rationale

**Version:** 4.8  
**Date:** 2025-12-11  
**Fixes:** 5 issues from V4.7 root cause analysis

---

## Summary of Changes

| Issue | V4.7 Problem | V4.8 Fix | Why It Solves It |
|-------|--------------|----------|------------------|
| Schema deviation | LLM outputs text before JSON | Added "Output Format" section | Explicit instruction overrides LLM's natural behavior |
| Missing reasoning | No field for thinking | Added `reasoning` as first field | Gives LLM proper place to put analysis |
| structureDelta format | Single example, LLM invented own | Multiple examples + explicit rules | More examples = less improvisation |
| Collection vs Orchestration | No guidance when to use | Added "When to Use Each" section | Decision rule clarifies ambiguity |
| User prompt format | `[SECTION]` brackets | Changed to `### SECTION` | Consistent with system prompt styling |

---

## Issue 1: Schema Deviation (CRITICAL)

### Problem

V4.7 LLM output:
```
Looking at this round, I need to address...

Let me work through the 6-point framework:

## 1. Mission Alignment Check
...

```json
{ ... }
```
```

**Result:** System crash — JSON parser cannot handle text preamble.

### V4.8 Fix

Added new section in system prompt:

```markdown
### Output Format

**Your response must be pure JSON only.**

- Start directly with `{`
- End with `}`
- No explanation before the JSON
- No markdown code fences (no ```json)
- No rationale after the JSON

Put your reasoning INSIDE the `reasoning` field.
```

### Why It Solves It

1. **Explicit instruction** — LLM follows direct commands ("must be pure JSON only")
2. **Clear boundaries** — "Start directly with `{`" leaves no ambiguity
3. **Redirection** — "Put reasoning INSIDE the `reasoning` field" tells LLM where to put its thinking
4. **Negative examples** — "No markdown code fences" prevents common LLM habit

---

## Issue 2: Missing `reasoning` Field (CRITICAL)

### Problem

V4.7 schema:
```json
{
  "structureDelta": "...",
  "changes": [...],
  ...
}
```

LLM has nowhere to put its analysis → puts it outside JSON → crash.

### V4.8 Fix

Added `reasoning` as **first field** in schema:

```json
{
  "reasoning": "string — your assessment of current state, mission gaps, and planning decisions",
  
  "structureDelta": "...",
  ...
}
```

### Why It Solves It

1. **Proper outlet** — LLM has a designated place for thinking
2. **First position** — Being first field makes it natural starting point
3. **Clear description** — "assessment of current state, mission gaps, and planning decisions" guides what to include
4. **Matches Bootstrap** — Consistent with Bootstrap prompt which already has `reasoning`

---

## Issue 3: structureDelta Format Mismatch

### Problem

V4.7 showed ONE example:
```
Add Collection: "Marketing Materials"
  > Content: "Landing Page Copy" [operative-1]
```

LLM invented its own format:
```
[Orchestration] TODO List MVP
  [Decision] System Architecture Design
```

### V4.8 Fix

Added comprehensive section with multiple examples:

```markdown
### structureDelta Format

Use this EXACT format for nested product creation. Do NOT invent your own format.

**Adding products:**
```
Add Orchestration: "Module Name"
  > Decision: "Decision Name" [operative-1]
  > Collection: "Collection Name"
    > Content: "Item 1" [operative-2]
```

**Removing products:**
```
Remove: "Product Name" (UUID: abc123-def456)
```

**Format rules:**
- Always prefix with action: `Add` or `Remove`
- Specify type after action: `Add Orchestration:`, `Add Collection:`...
- Use `>` for children, indent with 2 spaces per level
- Include assignee in brackets `[operative-1]` for leaf nodes
```

Also added to "Common Mistakes":
```markdown
**structureDelta Errors:**
- ❌ Inventing your own format like `[Type] Name`
- ❌ Forgetting the `Add` or `Remove` prefix
```

### Why It Solves It

1. **Multiple examples** — Shows all node types (Orchestration, Decision, Collection, Content)
2. **Remove example** — LLM saw no Remove example before, so invented one
3. **Explicit rules** — "Always prefix with action" removes ambiguity
4. **Negative instruction** — "Do NOT invent your own format" directly addresses the problem
5. **Error examples** — Shows exactly what NOT to do

---

## Issue 4: Orchestration vs Collection Clarity

### Problem

V4.7 table showed WHAT they are but not WHEN to use:
```
| **Collection** | Group of related Content products | Content only |
| **Orchestration** | Complex multi-part work | Any type |
```

LLM used Collection incorrectly:
```
Collection: "Frontend Implementation"  ← WRONG
  > Content: "Component Specs"
  > Content: "Source Code"
  > Content: "Tests"
```

### V4.8 Fix

Added new section:

```markdown
### When to Use Each Product Type

**Collection** = Same-type atomic items sharing a semantic category
- Book chapters (all chapters, same structure)
- API endpoint documentation (all docs, same format)
- Test case files (all tests, same purpose)

**Orchestration** = Complex work spanning multiple domains/concerns
- Full feature module (design + implementation + tests + docs)
- Marketing campaign (budget + copy + channels + metrics)

**Decision rule:**
- If children are all the SAME TYPE of atomic content → **Collection**
- If children span DIFFERENT concerns/domains → **Orchestration**

**Example - WRONG:**
```
Collection: "Frontend Implementation"     ← WRONG: spans design, code, tests
```

**Example - RIGHT:**
```
Orchestration: "Frontend Implementation"  ← RIGHT: complex multi-domain work
```
```

### Why It Solves It

1. **Concrete examples** — Real-world cases (book chapters, API docs) make abstract concepts tangible
2. **Decision rule** — "SAME TYPE vs DIFFERENT concerns" is an actionable heuristic
3. **Wrong/Right comparison** — Shows the exact mistake and correction
4. **Bold formatting** — `→ **Collection**` makes the choice clear

---

## Issue 5: User Prompt Format Inconsistency

### Problem

V4.7 user prompt used brackets:
```
[MISSION]
Build MenuMaster...

[OBJECTIVES]
1. Reduce menu update time...
```

System prompt used markdown:
```markdown
### Your Purpose

You are the MISSION ARCHITECT...
```

### V4.8 Fix

Changed user prompt to markdown headers:

```markdown
### MISSION

{{session.mission_charter}}

### OBJECTIVES

{{session.underlying_objectives}}

### TEAM

{{#each members}}
...
```

### Why It Solves It

1. **Consistency** — Same styling as system prompt and Bootstrap
2. **Standard format** — Markdown headers are universally understood
3. **Better parsing** — LLM recognizes `###` as section boundaries
4. **Professional appearance** — Cleaner, more readable

---

## Additional Improvements in V4.8

### 1. Better Example Output

V4.7 example had no `reasoning` field. V4.8 example shows proper usage:

```json
{
  "reasoning": "Reviewing Round 2: Technical Architecture Spec has blocking security 
  collabs from Marcus (rate limiting, auth section). Database Schema is ready for 
  acceptance with no blockers. Jordan requested a Decision Product for POS Integration 
  Priority - this is valid and needed before we can finalize technical architecture...",
  
  "structureDelta": "Add Orchestration: \"Go-to-Market\"...",
  ...
}
```

### 2. Fixed Product Tree in Example

V4.7 example had "TODO List MVP" but mission was "MenuMaster". V4.8 fixes this:
- Changed to "Menu SaaS MVP"
- Used Orchestration for "Technical Foundation" (not Collection)

### 3. Enhanced Error Section

Added output-specific errors:
```markdown
**Output Errors:**
- ❌ Adding explanation text before or after the JSON
- ❌ Wrapping JSON in markdown code fences
- ❌ Forgetting to put reasoning in the `reasoning` field
```

---

## Testing Checklist

To validate V4.8 fixes:

- [ ] Run same MenuMaster test case
- [ ] Verify: Output starts with `{` (no preamble)
- [ ] Verify: `reasoning` field is present and populated
- [ ] Verify: structureDelta uses `Add Type:` format (not `[Type]`)
- [ ] Verify: Orchestration used for multi-domain work
- [ ] Compare with V4.7 results
