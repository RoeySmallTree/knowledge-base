# V4.7 Plan & Assign Root Cause Analysis

**Analysis Date:** 2025-12-11  
**Prompt Version:** V4.7  
**Purpose:** Identify root causes of failures and propose fixes for V4.8

---

## Executive Summary

V4.7 Plan & Assign has **critical structural flaws** that will cause system crashes in production. This document analyzes the root causes and provides specific fixes.

---

## CRITICAL Issue 1: Schema Deviation (SYSTEM CRASH RISK)

### The Problem

The LLM outputs **free-form text before the JSON**:

```
I'll work through the 6-point planning framework to structure this first round.

1. Mission Alignment Check:
- We need to establish core components for the TODO list MVP
...

```json
{
  "structureDelta": "..."
}
```

Rationale for decisions:
...
```

### Why This Crashes the System

- Backend parsers expect **pure JSON**
- `JSON.parse()` will throw on text preamble
- Even if caught, the system has no valid output to process
- **Result: Round fails, session hangs**

### Root Cause in V4.7 Prompt

The prompt **never explicitly states** that output must be pure JSON:

```markdown
### Output Schema

```json
{
  "structureDelta": "string — text tree for nested creations/removals (optional)",
  ...
}
```
```

The LLM interprets this as "here's the schema" but not "output ONLY this schema".

### Evidence from Bootstrap

Bootstrap V4.7+ explicitly says output the schema, and LLM outputs clean JSON. Plan & Assign lacks this clarity.

### Fix for V4.8

Add explicit output enforcement section:

```markdown
### Output Rules

**Your response must be pure JSON only.**

- No text before the JSON
- No text after the JSON  
- No markdown code fences (```)
- No explanation or rationale outside the JSON

If you need to explain your reasoning, use the `reasoning` field inside the JSON.

**BAD (will crash the system):**
```
Let me analyze this...

{
  "structureDelta": "..."
}

Here's why I made these decisions...
```

**GOOD:**
```json
{
  "reasoning": "Analysis: mission needs X, Y, Z...",
  "structureDelta": "..."
}
```
```

---

## CRITICAL Issue 2: Missing `reasoning` Field

### The Problem

Bootstrap schema has a `reasoning` field:

```json
{
  "reasoning": "string — your thought process interpreting the mission",
  "mission_charter": "...",
  ...
}
```

Plan & Assign schema does NOT:

```json
{
  "structureDelta": "string",
  "changes": [...],
  "assignments": [...],
  ...
}
```

### Why This Causes Schema Deviation

- LLMs naturally want to explain their thinking
- Without a designated field, they add it as free-form text
- This causes Issue 1 (text preamble)

### Root Cause

Schema inconsistency across CABAL steps. Bootstrap was designed with reasoning, Plan & Assign wasn't.

### Fix for V4.8

Add `reasoning` as the first field in the schema:

```json
{
  "reasoning": "string — your strategic analysis: mission alignment, structural gaps, assignment rationale",
  
  "structureDelta": "string — text tree for nested creations/removals (optional)",
  ...
}
```

---

## Issue 3: structureDelta Format Mismatch

### The Problem

**Prompt specifies this format:**
```
Add Collection: "Marketing Materials"
  > Content: "Landing Page Copy" [operative-1]
  > Content: "Email Sequences" [operative-2]
```

**LLM outputs this format:**
```
[Orchestration] TODO List MVP
  [Decision] System Architecture Design
  [Collection] Frontend Implementation
    [Content] Core UI Components
```

### Why This Matters

- Backend parser expects specific format
- Invented format may fail to parse
- Even if it parses, hierarchy might be wrong

### Root Cause

- Only ONE example in the prompt
- Format rules are not explicit
- LLM improvised a "cleaner" looking format

### Fix for V4.8

Add explicit format rules with multiple examples:

```markdown
### structureDelta Format Rules

Use this EXACT format for nested product creation:

**Syntax:**
```
[Action] [Type]: "[Name]" [assignee]
  > [Type]: "[Name]" [assignee]
    > [Type]: "[Name]" [assignee]
```

**Actions:** `Add`, `Remove`, `Move`
**Types:** `Content`, `Decision`, `Collection`, `Orchestration`
**Assignee:** `[operative-X]` (optional, only for Content/Decision)

**Example 1 - Marketing Campaign:**
```
Add Orchestration: "Marketing Campaign"
  > Decision: "Channel Strategy" [operative-2]
  > Collection: "Ad Creatives"
    > Content: "Facebook Ad Copy" [operative-1]
    > Content: "Google Ad Copy" [operative-1]
  > Content: "Campaign Budget" [operative-2]
```

**Example 2 - Technical Module:**
```
Add Orchestration: "Authentication Module"
  > Decision: "Auth Strategy (JWT vs Session)"
  > Content: "Auth API Spec" [operative-1]
  > Content: "Auth Implementation" [operative-1]
  > Content: "Auth Tests" [operative-1]
```

**Example 3 - Content Collection:**
```
Add Collection: "API Endpoints"
  > Content: "GET /users" [operative-1]
  > Content: "POST /users" [operative-1]
  > Content: "DELETE /users/:id" [operative-1]
```

**DO NOT invent your own format.**
```

---

## Issue 4: Orchestration vs Collection Confusion

### The Problem

LLM used `Collection` for "Frontend Implementation" and "Backend Implementation":

```
[Collection] Frontend Implementation
  [Content] Core UI Components
  [Content] State Management
  [Content] Frontend Tests
```

This is **incorrect**. Frontend Implementation is complex multi-domain work (design, implementation, testing) — it should be an **Orchestration**.

### Root Cause

The prompt's guidance is too abstract:

```markdown
| **Collection** | Group of related Content products | Content only |
| **Orchestration** | Complex multi-part work | Any type |
```

"Related Content products" vs "Complex multi-part work" is vague.

### Fix for V4.8

Add concrete examples with clear decision criteria:

```markdown
### When to Use Collection vs Orchestration

**Use Collection when:**
- All children are the SAME TYPE of content
- Items are interchangeable/parallel
- No dependencies between children
- Think: "list of similar things"

**Collection Examples:**
- Book Chapters (all are chapter content)
- API Endpoints (all are endpoint specs)
- Test Cases (all are test content)
- Email Templates (all are email content)
- Product Pages (all are page content)

**Use Orchestration when:**
- Work spans multiple domains/phases
- Children have dependencies on each other
- Different types of work (design → implement → test)
- Think: "complex project with phases"

**Orchestration Examples:**
- Frontend Module (design + components + state + tests)
- Marketing Campaign (strategy + budget + copy + creatives)
- Feature Development (spec + implementation + tests + docs)
- Research Project (hypothesis + methodology + data + analysis)

**Quick Test:**
- "Is this a LIST of similar things?" → Collection
- "Is this a PROJECT with phases?" → Orchestration
```

---

## Summary of V4.8 Fixes

| Issue | Severity | Fix |
|-------|----------|-----|
| Schema Deviation | CRITICAL | Add "Output Rules" section enforcing pure JSON |
| Missing reasoning | CRITICAL | Add `reasoning` field to schema |
| structureDelta format | HIGH | Add explicit format rules + 3 examples |
| Collection vs Orchestration | MEDIUM | Add decision criteria + concrete examples |

---

## V4.8 Prompt Checklist

Before finalizing V4.8, verify:

- [ ] `reasoning` field added to schema (first field)
- [ ] "Output Rules" section added with BAD/GOOD examples
- [ ] structureDelta format rules with 3+ examples
- [ ] Collection vs Orchestration decision guide added
- [ ] Example output updated to show pure JSON with reasoning field
- [ ] No text preamble in example output

---

## Appendix: Full LLM Output (Evidence)

```json
{"id":"gen-1765293541-UTbQ2CDHmzLGufQEX91M","provider":"Amazon Bedrock","model":"anthropic/claude-3.5-sonnet","object":"chat.completion","created":1765293541,"choices":[{"logprobs":null,"finish_reason":"stop","native_finish_reason":"stop","index":0,"message":{"role":"assistant","content":"I'll work through the 6-point planning framework to structure this first round.\n\n1. Mission Alignment Check:\n- We need to establish core components for the TODO list MVP\n- Key areas needed: architecture design, frontend, backend, and testing infrastructure\n- Focus on meeting performance and reliability objectives\n\n2-3. Structure Decisions:\nWe need to create a logical structure under the MVP orchestration product to cover all mission aspects.\n\nLet me create the structure:\n\n```json\n{\n  \"structureDelta\": \"...",
...
```

Note the `content` field starts with "I'll work through..." — this is the text preamble that crashes the parser.
