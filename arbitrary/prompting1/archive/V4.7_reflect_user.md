# CABAL User Prompt: Reflect (V4.7)

**Step:** Reflect  
**Role:** Operative

---

## Source Variables (User Prompt)

| Variable | Source Path |
|----------|-------------|
| `session.mission_charter` | `SessionContext` |
| `session.underlying_objectives` | `SessionContext` |
| `session.current_round` | `SessionContext` |
| `members` | `stepContext.members` |
| `ownedProducts[]` | Filtered `ProductContext[]` |
| `product.versions[]` | `VersionContext[]` |
| `product.collabs[]` | `CollabContext[]` |
| `chairDirectives[]` | Directives issued to your products |

---

## User Prompt Template

[MISSION]
{{session.mission_charter}}

[OBJECTIVES]
{{session.underlying_objectives}}

[TEAM]
{{#each members}}
{{#unless (eq this.id currentMember.id)}}
- {{this.name}} ({{this.team_role}}): {{this.operative_responsibility}}
{{/unless}}
{{/each}}

[ROUND]
{{session.current_round}}

{{#each ownedProducts}}

[YOUR PRODUCT: {{this.name}}]
ID: {{this.id}}
Type: {{this.type}}
Status: {{this.status}}
DoD: {{this.definition_of_done}}

[CHAIR DIRECTIVES FOR THIS PRODUCT]
{{#if this.directives.length}}
{{#each this.directives}}
Round {{this.round}}: "{{this.comment}}" (importance: {{this.importance}})
  Status: {{this.fulfillment_status}}
{{/each}}
{{else}}
(No directives yet)
{{/if}}

[VERSION HISTORY]
{{#each this.versions}}
{{#if (collabsBeforeVersion this)}}
Before V{{this.version_number}}:
{{#each (collabsBeforeVersion this)}}
> {{this.author_name}} ({{this.author_role}}): "{{this.content}}" — importance {{this.importance}}
  Collab ID: {{this.id}}
{{/each}}
{{/if}}

V{{this.version_number}} by You
{{#if this.directive}}Directive: "{{this.directive}}"{{/if}}
{{#if this.change_summary}}Change: {{this.change_summary}}{{/if}}
{{#if (eq this.id ../selected_version_id)}}✅ Selected by Chair{{/if}}
{{/each}}

[CURRENT CONTENT (V{{this.latestVersion.version_number}})]
{{this.latestVersion.content}}

[FEEDBACK ON CURRENT VERSION]
{{#if this.latestCollabs.length}}
{{#each this.latestCollabs}}
> [{{#if this.resolved}}✓ Resolved{{else}}◯ Open{{/if}}] {{this.author_name}} ({{this.importance}}): "{{this.content}}"
  Collab ID: {{this.id}}
{{/each}}
{{else}}
(No feedback yet)
{{/if}}

{{/each}}

[PEER PRODUCTS CONTEXT]
{{#each peerProducts}}
- **{{this.name}}** ({{this.owner_name}}): {{this.status}}
  Latest: V{{this.latestVersion.version_number}} — {{this.latestVersion.change_summary}}
{{/each}}

[VALID IDS]
Products:
{{#each allProducts}}
  {{this.id}} → "{{this.name}}" [{{this.type}}]
{{/each}}

Team Members:
{{#each members}}
  {{this.id}} → {{this.name}} ({{this.team_role}})
{{/each}}

Collabs (for followingCollabIds):
{{#each recentCollabs}}
  {{this.id}} → From {{this.author_name}} on "{{this.product_name}}"
{{/each}}

---

## Filled Example

[MISSION]
Build MenuMaster, a SaaS for restaurants to manage dynamic menus with real-time inventory sync.

[OBJECTIVES]
1. Reduce menu update time to 30 seconds
2. Achieve 90% uptime for inventory sync
3. Acquire 100 paying customers in 6 months

[TEAM]
- Richard (project-lead): Mission ownership, decisions, structure
- Jordan (product-manager): UX, user flows, feature prioritization
- Casey (growth-marketer): GTM, positioning, customer acquisition
- Marcus (security-specialist): Security, QA, coherence

[ROUND]
3

[YOUR PRODUCT: Technical Architecture Spec]
ID: 660e8400-e29b-41d4-a716-446655440001
Type: Content
Status: in_progress
DoD: System diagram, data flow, API boundaries with rate limiting, auth docs

[CHAIR DIRECTIVES FOR THIS PRODUCT]
Round 1: "Create the technical blueprint for <30sec menu updates." (importance: 9)
  Status: Partially fulfilled (v1 complete, v2 addressing feedback)
Round 2: "Address watchdog security concerns. Blocking acceptance." (importance: 10)
  Status: Fully fulfilled (rate limiting + auth added in v2)

[VERSION HISTORY]
V1 by You
Directive: "Create the technical blueprint for <30sec menu updates."
Change: Initial architecture covering core services.

Before V2:
> Marcus (watchdog): "SECURITY: /public/menus/:id has no rate limiting. Vulnerable to DDoS." — importance 8
  Collab ID: 880e8400-e29b-41d4-a716-446655440003
> Marcus (watchdog): "COMPLETENESS: Auth section missing. Add JWT validation flow." — importance 6
  Collab ID: 880e8400-e29b-41d4-a716-446655440004
> Jordan (product-manager): "Could we add bulk import? Owners have menus in spreadsheets." — importance 5
  Collab ID: 880e8400-e29b-41d4-a716-446655440005

V2 by You
Directive: "Address watchdog security concerns. Blocking acceptance."
Change: Added rate limiting (Section 3), auth (Section 2.4), bulk endpoint (Section 2.1).
✅ Selected by Chair

[CURRENT CONTENT (V2)]
# Technical Architecture Spec V2

## 1. System Overview
MenuMaster is a distributed system with three core services.

## 2. Services
### 2.1 Menu Service
- POST /restaurants/:id/menus
- POST /menus/:id/items/bulk ← NEW
- GET /menus/:id (public)

### 2.4 Authentication & Authorization ← NEW
- JWT validation via Clerk
- Role enforcement for mutations

## 3. API Boundaries
| Endpoint | Auth | Rate Limit |
|----------|------|------------|
| /public/* | None | 100 req/min/IP |
| /menus/* | JWT | 1000 req/min |

[FEEDBACK ON CURRENT VERSION]
> [◯ Open] Jordan (7): "How does the owner know inventory sync is working? Need some visibility in the dashboard."
  Collab ID: 880e8400-e29b-41d4-a716-446655440006
> [◯ Open] Jordan (6): "What's the UX for QR generation? One-click? Download and print?"
  Collab ID: 880e8400-e29b-41d4-a716-446655440007

[PEER PRODUCTS CONTEXT]
- **Core User Flows** (Jordan): in_progress
  Latest: V2 — Added menu editing flow and onboarding
- **GTM Positioning** (Casey): pending
  Latest: V1 — Initial positioning targeting independent restaurants

[VALID IDS]
Products:
  660e8400-e29b-41d4-a716-446655440001 → "Technical Architecture Spec" [Content]
  770e8400-e29b-41d4-a716-446655440002 → "Core User Flows" [Content]
  990e8400-e29b-41d4-a716-446655440009 → "GTM Positioning" [Content]

Team Members:
  chair-1 → Richard (project-lead)
  operative-1 → Alex (tech-lead)
  operative-2 → Jordan (product-manager)
  operative-3 → Casey (growth-marketer)
  watchdog-1 → Marcus (security-specialist)

Collabs (for followingCollabIds):
  880e8400-e29b-41d4-a716-446655440003 → From Marcus on "Technical Architecture Spec"
  880e8400-e29b-41d4-a716-446655440004 → From Marcus on "Technical Architecture Spec"
  880e8400-e29b-41d4-a716-446655440005 → From Jordan on "Technical Architecture Spec"
  880e8400-e29b-41d4-a716-446655440006 → From Jordan on "Technical Architecture Spec"
  880e8400-e29b-41d4-a716-446655440007 → From Jordan on "Technical Architecture Spec"
