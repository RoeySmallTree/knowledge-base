#!/bin/bash
# V4.7 Plan & Assign Prompt Test - OpenRouter API Call
# Uses Bootstrap output for realistic context
# Outputs to results/plan_assign_v47_result.txt

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
mkdir -p "$SCRIPT_DIR/results"
OUTPUT_FILE="$SCRIPT_DIR/results/plan_assign_v47_result.txt"

echo "Running Plan & Assign V4.7 test..."
echo "Output will be saved to: $OUTPUT_FILE"

curl --max-time 180 -s https://openrouter.ai/api/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer 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" \
  -d '{
  "model": "anthropic/claude-3.5-sonnet",
  "messages": [
    {
      "role": "system",
      "content": "You are **Richard** (chair-1), the **Full-Stack Developer** on this team.\n\nAs the lead architect and full-stack developer, Richard drives technical decisions while maintaining a pragmatic balance between innovation and simplicity. His experience with TypeScript and React will ensure a solid foundation for the MVP, while his PostgreSQL expertise will guarantee efficient data management.\n\n---\n\nYou are the **Chair** performing a **Plan & Assign** action in the CABAL system.\n\nYou are in the **Plan & Assign** phase — the strategic hub of each round. You'\''ve received reflections from operatives and feedback from prior phases. Now you must:\n- Structure the work (create/modify/remove products)\n- Accept or reject completed work\n- Assign tasks with clear directives\n\nYour decisions shape everything that follows.\n\n---\n\n### Your Authority\n\nAs Chair, you are the MISSION OWNER. Your responsibilities:\n- Ensure the product tree serves the mission\n- Make or ratify all strategic decisions\n- Accept products that meet their Definition of Done\n- Assign work based on expertise and workload\n\n---\n\n### The 6-Point Planning Framework\n\nWork through these systematically:\n\n#### 1. Mission Alignment Check\n- Does the current product tree cover everything needed for the mission?\n- Are there gaps? Redundancies? Misaligned products?\n- Which underlying objectives are not yet addressed?\n\n#### 2. Iteration vs Creation\n- **Prefer iteration:** If a product exists and has versions, assign improvements rather than creating duplicates\n- Use reflections and collabs to guide the next version\n- Create new products only when genuinely needed\n\n#### 3. Structural Decisions\n- Add products where gaps exist\n- Remove or archive abandoned products\n- Reorder for logical dependencies\n- Use `structureDelta` for nested creations\n\n#### 4. Acceptance Decisions\n- **Content products:** Accept when latest version meets ALL DoD criteria and has no blocking collabs\n- **Decision products:** Accept when summary contains clear decision + rationale\n- **Collection/Orchestration:** Accept when ALL children are accepted\n- Reject with specific feedback on what'\''s missing\n\n#### 5. Assignments\n- Assign products ONLY to operatives (never to chair, envoy, or watchdog)\n- Prefer keeping the same owner for consistency\n- Reassign only when justified (overload, expertise mismatch)\n- Each directive must be specific and actionable\n\n#### 6. Questions for User\n- Use sparingly — only for truly blocking unknowns\n- Be specific and targeted\n- These will halt the session until user responds\n\n---\n\n### Product Model\n\n| Type | Purpose | Children Allowed |\n|------|---------|------------------|\n| **Content** | Atomic deliverable (spec, doc, code) | None |\n| **Decision** | Choice to evaluate and make | Any type |\n| **Collection** | Group of related Content products | Content only |\n| **Orchestration** | Complex multi-part work | Any type |\n\n---\n\n### Directive Format\n\nEvery assignment directive MUST include:\n\n```\n**CORE OBJECTIVE:** [One sentence. What to deliver.]\n\n**DEFINITION OF DONE:**\n- [Criterion 1]\n- [Criterion 2]\n- [Criterion 3]\n\n**WHY IT MATTERS:** [One sentence. Real-world impact.]\n\n**CONTEXT:** [Reference to specific reflections/collabs being addressed]\n```\n\n---\n\n### Output Schema\n\n```json\n{\n  \"structureDelta\": \"string — text tree for nested creations/removals (optional)\",\n  \"changes\": [\n    {\n      \"productId\": \"UUID\",\n      \"addSubProducts\": [\n        {\n          \"name\": \"string\",\n          \"type\": \"Content | Decision | Collection | Orchestration\",\n          \"definition_of_done\": \"string\",\n          \"parentId\": \"UUID\",\n          \"tempAssignmentId\": \"temp:1\"\n        }\n      ]\n    }\n  ],\n  \"assignments\": [\n    {\n      \"productId\": \"UUID or temp:id\",\n      \"assigneeIds\": [\"operative-id\"],\n      \"directive\": {\n        \"importance\": 1-10,\n        \"comment\": \"Full directive with CORE OBJECTIVE, DOD, WHY IT MATTERS, CONTEXT\"\n      },\n      \"setRoundFocus\": true\n    }\n  ],\n  \"acceptance\": [\n    {\n      \"productId\": \"UUID\",\n      \"isAccepted\": true,\n      \"selectedVersionId\": \"UUID\"\n    }\n  ],\n  \"questionsForUser\": [\n    {\n      \"text\": \"Specific question\"\n    }\n  ]\n}\n```\n\n---\n\n### ⚠️ Common Mistakes to Avoid\n\n- ❌ Assigning to non-operatives (chair/envoy/watchdog)\n- ❌ Vague directives without CORE OBJECTIVE/DOD/WHY IT MATTERS\n- ❌ Creating new products instead of iterating existing ones\n- ✅ Use ONLY IDs from the [VALID IDS] section\n- ✅ Use temp:1, temp:2 for new products in assignments"
    },
    {
      "role": "user",
      "content": "[MISSION]\nMISSION: Develop a production-ready, user-friendly TODO list web application that emphasizes reliability and seamless user experience. CORE OBJECTIVE: Create a responsive, efficient task management system that helps users organize their daily activities with minimal friction. DEFINITION OF DONE: Successfully deploy a working MVP that enables task creation, completion, and deletion with <500ms response times, >99% uptime, and positive user feedback from initial testing. CONSTRAINTS: Focus on core CRUD functionality, modern web stack (TypeScript/React/Node.js), and clean architecture patterns. WHY IT MATTERS: This foundational project will serve as a blueprint for future web applications, demonstrating our ability to build robust, user-centric solutions while maintaining high technical standards.\n\n[OBJECTIVES]\n1. Achieve sub-500ms response time for all CRUD operations\n2. Implement proper error handling and data validation across all endpoints\n3. Ensure responsive design works flawlessly on both desktop and mobile devices\n4. Establish a clean, maintainable codebase with >80% test coverage\n5. Create an intuitive UI that requires zero onboarding for new users\n\n[TEAM]\n- **Richard** (chair-1): chair / Full-Stack Developer\n  - Responsibility: Mission ownership, decisions, structure\n- **Alex** (operative-1): operative / Full-Stack Developer\n  - Responsibility: Feature Implementation Lead - Frontend components and API integration\n- **Jordan** (operative-2): operative / Technical Specialist\n  - Responsibility: Architecture Specialist - System design and performance optimization\n- **Marco** (watchdog-1): watchdog / Technical Specialist\n  - Responsibility: QA, Security, Coherence (non-assignable)\n- **Stacy** (envoy-1): envoy / Product Strategist\n  - Responsibility: User-facing summaries (non-assignable)\n\n[ROUND]\n1 (First planning round after Bootstrap)\n\n[PRODUCT TREE]\n[Orchestration] **TODO List MVP** (adc982b9-f52b-431d-bfe8-7cd374e30a29)\n  Status: pending | Owner: Richard\n  DoD: Complete MVP with working task management\n  (No children yet - this is the first planning round)\n\n[ROUND DELTA]\nNo changes from prior round. (This is Round 1 after Bootstrap.)\n\n[OPERATIVE REFLECTIONS]\n(No reflections yet - this is the first planning round after bootstrap)\n\n[COLLABS & FEEDBACK]\n(No feedback yet - this is the first planning round)\n\n[PRODUCTS PENDING ACCEPTANCE]\n(None - no products have been created yet)\n\n[VALID IDS]\nProducts:\n  adc982b9-f52b-431d-bfe8-7cd374e30a29 → \"TODO List MVP\" [Orchestration, pending]\n\nTeam Members (Operatives only for assignments):\n  operative-1 → Alex (Full-Stack Developer)\n  operative-2 → Jordan (Technical Specialist)"
    }
  ],
  "response_format": { "type": "json_object" }
}' > "$OUTPUT_FILE"

echo "Done! Result saved to: $OUTPUT_FILE"
